name: Testes de Integração
on:
  push:
    branches: [ develop ]

jobs:
  laravel-tests:

    runs-on: ubuntu-latest
    #container: php:8.0
    services:
      # label used to access the service container
      postgres:
        # Docker Hub image
        image: postgres:latest
        env:
          # optional (defaults to `postgres`)
          POSTGRES_DB: postgres_db
          # required
          POSTGRES_PASSWORD: postgres
          # optional (defaults to `5432`)
          POSTGRES_PORT: 5432
          # optional (defaults to `postgres`)
          POSTGRES_USER: postgres
        ports:
          # maps tcp port 5432 on service container to the host
          - 5432:5432
        # set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
    - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
      with:
        php-version: '8.0'
    - uses: actions/checkout@v2
    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"
    - name: Install dependency
      run: |
        sudo apt-get install php-pgsql
    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
    - name: Generate key
      run: php artisan key:generate
    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache
    - name: Create Database
      run: |
        psql -h localhost -U postgres -c 'CREATE DATABASE "jacksparrow"';
        psql -h localhost -U postgres -d jacksparrow -c 'CREATE SCHEMA IF NOT EXISTS  maliin';
      
      env:
          PGPASSWORD: postgres
    - name: Execute migrations and setup server
      env:
        DB_USERNAME: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_DATABASE: jacksparrow
        DB_CONNECTION: pgsql
      run: |
        php artisan migrate
        php artisan serve &
    - name: Install Robot
      run: |
        sudo apt-get update -y  && \
        sudo apt-get install -y \
        libpq-dev \
        gcc && \
        pip3 install --no-cache-dir --upgrade pip && \
        pip3 install -U --no-cache-dir  \
                  robotframework \
                  robotframework-requests \
                  robotframework-databaselibrary \
                  psycopg2
      env:
          PGPASSWORD: postgres
    - name: Integration tests
      run: |
        python3 -m robot --removekeywords name:Connect_To_Database .
      env:
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_PORT: 5432
          DB_HOST: localhost
          DB_DATABASE: jacksparrow
          DB_CONNECTION: pgsql
          ROBOT_URL: http://localhost:8000/api
